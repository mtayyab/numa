<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="008-create-analytics-events" author="numa-team">
        <createTable tableName="analytics_events">
            <column name="id" type="UUID" defaultValueComputed="gen_random_uuid()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="restaurant_id" type="UUID">
                <constraints nullable="false" foreignKeyName="fk_analytics_restaurant" references="restaurants(id)"/>
            </column>
            <column name="session_id" type="UUID">
                <constraints foreignKeyName="fk_analytics_session" references="dining_sessions(id)"/>
            </column>
            <column name="order_id" type="UUID">
                <constraints foreignKeyName="fk_analytics_order" references="orders(id)"/>
            </column>
            <column name="event_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="event_category" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="event_data" type="JSONB"/>
            <column name="user_agent" type="TEXT"/>
            <column name="ip_address" type="VARCHAR(45)"/>
            <column name="occurred_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex tableName="analytics_events" indexName="idx_analytics_restaurant_id">
            <column name="restaurant_id"/>
        </createIndex>
        
        <createIndex tableName="analytics_events" indexName="idx_analytics_event_type">
            <column name="event_type"/>
        </createIndex>
        
        <createIndex tableName="analytics_events" indexName="idx_analytics_occurred_at">
            <column name="occurred_at"/>
        </createIndex>
        
        <createIndex tableName="analytics_events" indexName="idx_analytics_session_id">
            <column name="session_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="008-create-daily-stats" author="numa-team">
        <createTable tableName="daily_restaurant_stats">
            <column name="id" type="UUID" defaultValueComputed="gen_random_uuid()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="restaurant_id" type="UUID">
                <constraints nullable="false" foreignKeyName="fk_daily_stats_restaurant" references="restaurants(id)"/>
            </column>
            <column name="date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="total_orders" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="total_revenue" type="DECIMAL(12,2)" defaultValue="0.00">
                <constraints nullable="false"/>
            </column>
            <column name="average_order_value" type="DECIMAL(10,2)" defaultValue="0.00">
                <constraints nullable="false"/>
            </column>
            <column name="total_sessions" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="average_session_duration" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="table_utilization_rate" type="DECIMAL(5,4)" defaultValue="0.0000">
                <constraints nullable="false"/>
            </column>
            <column name="popular_items" type="JSONB"/>
            <column name="peak_hours" type="JSONB"/>
            <column name="campaign_performance" type="JSONB"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addUniqueConstraint tableName="daily_restaurant_stats" 
                           columnNames="restaurant_id, date" 
                           constraintName="uk_restaurant_daily_stats"/>

        <createIndex tableName="daily_restaurant_stats" indexName="idx_daily_stats_restaurant_date">
            <column name="restaurant_id"/>
            <column name="date"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>
